<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="./node_modules/easymde/dist/easymde.min.css">
    <link rel="stylesheet" href="style.css">
    <meta charset="UTF-8">
    <title>Dream Journal</title>
</head>

<body>
    <h1>Dream Journal</h1>
    <div id="calendar-controls" style="text-align:center; margin-bottom:10px;">
        <button id="prev-month">&larr;</button>
        <span id="month-year-label"></span>
        <button id="next-month">&rarr;</button>
    </div>
    <!-- CALENDAR -->
    <div id="calendar"></div>


    <form id="dreamForm">
        <input type="date" id="date" required><br><br>
        <textarea id="dream" placeholder="Your dream..." style="display:none;"></textarea>
        <textarea id="interpretation" placeholder="Interpretation..." style="display:none;"></textarea>
        <button type="submit">Save Dream</button>
    </form>
    <script src="./node_modules/easymde/dist/easymde.min.js"></script>


    <h2>Past Dreams</h2>
    <div id="dreamsList"></div>

    <script>
        const { ipcRenderer } = require('electron');
        const { marked } = require('marked');
        const EasyMDE = window.EasyMDE;
        // 1) State for which month/year we’re viewing
        let currentDate = new Date();
        let currentYear = currentDate.getFullYear();
        let currentMonth = currentDate.getMonth(); // 0 = Jan

        const monthNames = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];

        // your existing editor setup...
        const dreamEditor = new EasyMDE({
            element: document.getElementById('dream'),
            placeholder: "Your dream…"
        });
        const interpEditor = new EasyMDE({
            element: document.getElementById('interpretation'),
            placeholder: "Your interpretation…"
        });

        let editingId = null;
        let tooltipEl = null;

        // 2) Update the label and re-render calendar
        function refreshCalendar(allDreams) {
            // update header
            document.getElementById('month-year-label').textContent =
                `${monthNames[currentMonth]} ${currentYear}`;

            renderCalendar(allDreams, currentYear, currentMonth);
        }
        // 3) Hook prev/next buttons
        document.getElementById('prev-month').addEventListener('click', async () => {
            if (--currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            const all = await ipcRenderer.invoke('load-dreams');
            refreshCalendar(all);
            // clear list if you want, or show only that month's dreams
            document.getElementById('dreamsList').innerHTML = '';
        });

        document.getElementById('next-month').addEventListener('click', async () => {
            if (++currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            const all = await ipcRenderer.invoke('load-dreams');
            refreshCalendar(all);
            document.getElementById('dreamsList').innerHTML = '';
        });

        function showTooltip(e, dreamsForDay) {
            hideTooltip();

            tooltipEl = document.createElement('div');
            tooltipEl.className = 'tooltip';

            // build content
            tooltipEl.innerHTML = dreamsForDay.map(d => {
                const match = d.dream.match(/^#\s*(.+)$/m);
                const title = match ? match[1] : d.dream.split('\n')[0].slice(0, 30) + '…';
                const snippet = d.dream.replace(/^#.*\n?/, '').slice(0, 60).replace(/\n/g, ' ') + '…';
                return `<strong>${title}</strong><br><em>${snippet}</em>`;
            }).join('<hr style="border-color:#444;margin:4px 0">');

            document.body.appendChild(tooltipEl);

            // initial position: to the right of the cell
            const rect = e.currentTarget.getBoundingClientRect();
            let top = rect.top + window.scrollY + 2;
            let left = rect.right + 8;

            tooltipEl.style.top = top + 'px';
            tooltipEl.style.left = left + 'px';

            // now clamp so it never overflows the viewport
            const tipRect = tooltipEl.getBoundingClientRect();
            const margin = 8;

            // if it goes off the right edge, flip to the left side
            if (tipRect.right > window.innerWidth - margin) {
                left = rect.left - tipRect.width - margin;
                tooltipEl.style.left = `${Math.max(margin, left)}px`;
            }

            // if it goes off the bottom edge, shift it up
            if (tipRect.bottom > window.innerHeight - margin) {
                top = window.innerHeight - tipRect.height - margin;
                tooltipEl.style.top = `${Math.max(margin, top)}px`;
            }
        }

        function hideTooltip() {
            if (tooltipEl) {
                tooltipEl.remove();
                tooltipEl = null;
            }
        }



        // 1) render calendar for the current month
        function renderCalendar(allDreams, year, month) {
            const cal = document.getElementById('calendar');
            //const now = new Date();
            const firstDay = new Date(year, month, 1).getDay(); // 0=Sun…6=Sat
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let html = `<table class="calendar-table">
      <caption>${monthNames[month]} ${year}</caption>
      <thead><tr>
        <th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th>
        <th>Thu</th><th>Fri</th><th>Sat</th>
      </tr></thead><tbody><tr>`;

            let day = 1;
            // 6 rows max
            for (let week = 0; week < 6; week++) {
                for (let weekday = 0; weekday < 7; weekday++) {
                    if ((week === 0 && weekday < firstDay) || day > daysInMonth) {
                        html += '<td></td>';
                    } else {
                        const dd = String(day).padStart(2, '0');
                        const mm = String(month + 1).padStart(2, '0');
                        const dateStr = `${year}-${mm}-${dd}`;
                        const hasDream = allDreams.some(d => d.date === dateStr);
                        html += `
            <td class="calendar-day ${hasDream ? 'has-dream' : ''}"
                data-date="${dateStr}">
              ${day}
            </td>`;
                        day++;
                    }
                }
                html += '</tr>';
                if (day > daysInMonth) break;
                html += '<tr>';
            }

            cal.innerHTML = html + '</tbody></table>';
            cal.innerHTML = html;

            const dreamsByDate = allDreams.reduce((acc, d) => {
                (acc[d.date] = acc[d.date] || []).push(d);
                return acc;
            }, {});

            // attach clicks
            cal.querySelectorAll('.calendar-day').forEach(cell => {
                const date = cell.dataset.date;
                const dayDreams = dreamsByDate[date] || [];
                if (dayDreams.length) {
                    // highlight exists already via .has-dream
                    cell.addEventListener('mouseenter', e => showTooltip(e, dayDreams));
                    cell.addEventListener('mouseleave', hideTooltip);
                }
            });

            //attach clicks
            document.querySelectorAll('.calendar-day').forEach(cell => {
                cell.addEventListener('click', () => {
                    const date = cell.dataset.date;
                    document.getElementById('date').value = date;
                    loadDreams(date);
                });
            });
        }

        // 2) load dreams, render calendar & list (optionally filtered)
        async function loadDreams(filterDate = null) {
            const allDreams = await ipcRenderer.invoke('load-dreams');
            // draw calendar with *all* dreams
            refreshCalendar(allDreams);

            // now filter for the list
            const dreams = filterDate
                ? allDreams.filter(d => d.date === filterDate)
                : allDreams;

            const list = document.getElementById('dreamsList');
            if (!dreams.length) {
                list.innerHTML = '<p><em>No dreams for this date.</em></p>';
                return;
            }

            list.innerHTML = dreams.map(d => `
      <div class="dream">
        <strong>${d.date}</strong><br>
        <div>${marked.parse(d.dream)}</div>
        <div style="margin-top:10px;font-size:0.9em;color:#aaa;">
          ${marked.parse(d.interpretation)}
        </div>
        <button onclick="editDream(${d.id})">Edit</button>
      </div>
    `).join('');
        }

        // 3) editDream and form submit as before
        window.editDream = async function (id) {
            const all = await ipcRenderer.invoke('load-dreams');
            const d = all.find(x => x.id === id);
            if (!d) return;
            document.getElementById('date').value = d.date;
            dreamEditor.value(d.dream);
            interpEditor.value(d.interpretation);
            editingId = id;
        };

        document.getElementById('dreamForm').addEventListener('submit', async e => {
            e.preventDefault();

            if (!dreamEditor.value().trim()) {
                alert("Please write your dream before saving.");
                return;
            }
            const dreamData = {
                id: editingId,
                date: document.getElementById('date').value,
                dream: dreamEditor.value(),
                interpretation: interpEditor.value()    // ← correctly spelled and on one line
            };

            await ipcRenderer.invoke('save-dream', dreamData);

            // clear form + editors
            document.getElementById('dreamForm').reset();
            dreamEditor.value("");
            interpEditor.value("");
            editingId = null;

            loadDreams();   // re-render calendar & list
        });

        // initial render
        console.log("🧪 HTML script is running");
        loadDreams();
    </script>

</body>

</html>